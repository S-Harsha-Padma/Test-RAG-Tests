name: Test IMS OAuth Authentication

on:
  push:
    branches:
      - check

jobs:
  test-ims-auth:
    name: Test IMS OAuth & Load Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 -y
          k6 version

      # - name: Get IMS Access Token via Authorization Code
      #   id: token
      #   run: |
      #     echo "Requesting IMS token via OAuth Authorization Code..."
          
      #     RESPONSE=$(curl -s -X POST "https://ims-na1-stg1.adobelogin.com/ims/token/v3" \
      #       -H "Content-Type: application/x-www-form-urlencoded" \
      #       -d "grant_type=authorization_code" \
      #       -d "client_id=${{ secrets.CLIENTID_STAGE }}" \
      #       -d "client_secret=${{ secrets.CLIENTSECRET_STAGE }}" \
      #       -d "code=${{ secrets.AUTH_CODE_STAGE }}" \
      #       -d "scope=system,openid,AdobeID,read_organizations")
          
      #     echo "Response received"
          
      #     TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')
          
      #     if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
      #       echo "Failed to get access token"
      #       echo "Full response: $RESPONSE"
      #       exit 1
      #     fi
          
      #     echo "::add-mask::$TOKEN"
      #     echo "access_token=$TOKEN" >> $GITHUB_OUTPUT
      #     echo "Got IMS token successfully!"

      # - name: Validate Token
      #   run: |
      #     echo "Validating IMS token..."
          
      #     # Check token is not empty
      #     if [ -z "${{ steps.token.outputs.access_token }}" ]; then
      #       echo "Token is empty"
      #       exit 1
      #     fi
          
      #     # Check token format (JWT has 3 parts separated by dots)
      #     TOKEN_PARTS=$(echo "${{ steps.token.outputs.access_token }}" | tr '.' '\n' | wc -l)
      #     if [ "$TOKEN_PARTS" -ne 3 ]; then
      #       echo "Token format invalid (expected 3 parts, got $TOKEN_PARTS)"
      #       exit 1
      #     fi
          
      #     echo "Token format valid!"

      - name: Run k6 Load Test
        id: loadtest
        continue-on-error: true  # Don't fail workflow - load balancing is in progress
        env:
          APIM_ENDPOINT: "https://commerce-docs-dev-apim.azure-api.net"
          # IMS_TOKEN: ${{ steps.token.outputs.access_token }}
          IMS_TOKEN: ${{ secrets.IMS_TOKEN_FREE_STAGE_DUMMY }}
        run: npm run test:load

      - name: Load Test Summary
        if: always()
        run: |
          echo "## Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.loadtest.outcome }}" == "success" ]; then
            echo "**Status: PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "All thresholds met!" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status: COMPLETED WITH ERRORS**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Backend scaling/load balancing will be handled in phase2." >> $GITHUB_STEP_SUMMARY
            echo "500 errors are expected during this phase." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The test ran successfully but thresholds were not met due to infrastructure work." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This workflow is marked as successful to not block development.*" >> $GITHUB_STEP_SUMMARY

      # Analyze results - detailed metrics
      - name: Analyze Results
        if: always()
        run: |
          echo "### Detailed Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for any result files
          if ls load-test/results/*.json 1> /dev/null 2>&1; then
            echo "### Load Test Summary" >> $GITHUB_STEP_SUMMARY
            for file in load-test/results/*.json; do
              echo "- **Test:** $(basename $file .json)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract metrics from k6 JSON output (matching k6 textSummary)
              # Test Duration
              DURATION=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "data_received") | .data.time' 2>/dev/null | head -1)
              
              # Total Requests
              TOTAL_REQS=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_reqs") | .data.value' 2>/dev/null | tail -1)
              
              # Request Rate
              REQ_RATE=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_reqs") | .data.rate' 2>/dev/null | tail -1)
              
              # Average Duration
              AVG_DURATION=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_req_duration") | .data.value' 2>/dev/null | head -1)
              
              # P95 Latency
              P95=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_req_duration" and .data.tags.expected_response == "true") | .data.value' 2>/dev/null | tail -1)
              
              # Success/Error Rates
              FAILED_RATE=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_req_failed") | .data.value' 2>/dev/null | tail -1)
              
              # Token Usage
              TOKENS_USED=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "tokens_used") | .data.value' 2>/dev/null | tail -1)
              
              # Display metrics (matching k6 textSummary format)
              if [ ! -z "$TOTAL_REQS" ] && [ "$TOTAL_REQS" != "null" ]; then
                TOTAL_REQS_INT=$(echo "$TOTAL_REQS" | xargs printf "%.0f" 2>/dev/null || echo "$TOTAL_REQS")
                echo "  - **Total Requests:** ${TOTAL_REQS_INT}" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ ! -z "$REQ_RATE" ] && [ "$REQ_RATE" != "null" ]; then
                REQ_RATE_FMT=$(echo "$REQ_RATE" | xargs printf "%.2f" 2>/dev/null || echo "$REQ_RATE")
                echo "  - **Request Rate:** ${REQ_RATE_FMT} req/s" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "  **Response Times:**" >> $GITHUB_STEP_SUMMARY
              
              if [ ! -z "$AVG_DURATION" ] && [ "$AVG_DURATION" != "null" ]; then
                AVG_FMT=$(echo "$AVG_DURATION" | xargs printf "%.2f" 2>/dev/null || echo "$AVG_DURATION")
                echo "  - Average: ${AVG_FMT}ms" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ ! -z "$P95" ] && [ "$P95" != "null" ]; then
                P95_FMT=$(echo "$P95" | xargs printf "%.2f" 2>/dev/null || echo "$P95")
                echo "  - P95: ${P95_FMT}ms" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ ! -z "$FAILED_RATE" ] && [ "$FAILED_RATE" != "null" ]; then
                SUCCESS_RATE=$(echo "(1 - $FAILED_RATE) * 100" | bc -l 2>/dev/null | xargs printf "%.2f" 2>/dev/null || echo "100.00")
                ERROR_PCT=$(echo "$FAILED_RATE * 100" | bc -l 2>/dev/null | xargs printf "%.2f" 2>/dev/null || echo "0.00")
                echo "  - **Success Rate:** ${SUCCESS_RATE}%" >> $GITHUB_STEP_SUMMARY
                if (( $(echo "$FAILED_RATE > 0.01" | bc -l 2>/dev/null || echo 0) )); then
                  echo "  - **Error Rate:** ❌ ${ERROR_PCT}% (threshold: <1%)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "  - **Error Rate:** ✅ ${ERROR_PCT}%" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              if [ ! -z "$TOKENS_USED" ] && [ "$TOKENS_USED" != "null" ] && [ ! -z "$TOTAL_REQS" ] && [ "$TOTAL_REQS" != "null" ]; then
                TOKENS_INT=$(echo "$TOKENS_USED" | xargs printf "%.0f" 2>/dev/null || echo "$TOKENS_USED")
                AVG_TOKENS=$(echo "$TOKENS_USED / $TOTAL_REQS" | bc -l 2>/dev/null | xargs printf "%.0f" 2>/dev/null || echo "0")
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "  **Custom Metrics:**" >> $GITHUB_STEP_SUMMARY
                echo "  - Total Tokens Used: ${TOKENS_INT}" >> $GITHUB_STEP_SUMMARY
                echo "  - Avg Tokens/Request: ${AVG_TOKENS}" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No results found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full results available in artifacts." >> $GITHUB_STEP_SUMMARY
      
      # Upload results as artifacts
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results-${{ inputs.environment }}
          path: load-test/results/*.json
          retention-days: 10
