name: Load Testing

on:
  # Or run manually
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

jobs:
  load-test:
    name: Run k6 Load Tests - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}  # Use the selected environment (dev/prod)
    if: ${{ github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Install k6 binary
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 -y
          k6 version
      
      # Get IMS token for authentication
      - name: Get IMS Token
        id: ims-token
        run: |
          # Check for environment-specific personal token first
          if [ "${{ inputs.environment }}" = "prod" ]; then
            if [ -n "${{ secrets.IMS_TOKEN_PERSONAL_PROD }}" ]; then
              echo "Using personal Adobe token for PROD (premium tier)"
              TOKEN="${{ secrets.IMS_TOKEN_PERSONAL_PROD }}"
              echo "::add-mask::$TOKEN"
              echo "token=$TOKEN" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            if [ -n "${{ secrets.IMS_TOKEN_PERSONAL_STAGE }}" ]; then
              echo "Using personal Adobe token for STAGE (premium tier)"
              TOKEN="${{ secrets.IMS_TOKEN_PERSONAL_STAGE }}"
              echo "::add-mask::$TOKEN"
              echo "token=$TOKEN" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # Fallback to generic personal token (works for all environments)
          if [ -n "${{ secrets.IMS_TOKEN_PERSONAL }}" ]; then
            echo "Using generic personal Adobe token (premium tier)"
            TOKEN="${{ secrets.IMS_TOKEN_PERSONAL }}"
            echo "::add-mask::$TOKEN"
            echo "token=$TOKEN" >> $GITHUB_OUTPUT
            exit 0
          fi
  
          echo "Error: No token available for ${{ inputs.environment }}!"
          echo ""
          echo "To run load tests, add one of these secrets:"
          echo ""
          echo "Option 1 - Environment-specific token:"
          if [ "${{ inputs.environment }}" = "prod" ]; then
            echo "  - Secret name: IMS_TOKEN_PERSONAL_PROD"
          else
            echo "  - Secret name: IMS_TOKEN_PERSONAL_STAGE"
          fi
          echo "  - Get token: aio auth login --bare (using your ${{ inputs.environment }} Adobe account)"
          echo ""
          echo "Option 2 - Generic token (works for all environments):"
          echo "  - Secret name: IMS_TOKEN_PERSONAL"
          echo "  - Get token: aio auth login --bare"
          echo ""
          echo "This gives you premium tier (1000 calls/min) for testing!"
          exit 1
      
      # Run basic load test
      - name: Run Load Test on ${{ inputs.environment }}
        env:
          APIM_ENDPOINT: ${{ inputs.environment == 'prod' && vars.APIM_ENDPOINT_PROD || vars.APIM_ENDPOINT_STAGE }}
          IMS_TOKEN: ${{ steps.ims-token.outputs.token }}
          CACHE_ENV: ${{ inputs.environment }}  # For cache isolation
        run: npm run test:load
      
      # Analyze results
      - name: Analyze Results
        if: always()
        run: |
          echo "## Load Test Results - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for any result files
          if ls load-test/results/*.json 1> /dev/null 2>&1; then
            echo "### Load Test Summary" >> $GITHUB_STEP_SUMMARY
            for file in load-test/results/*.json; do
              echo "- **Test:** $(basename $file .json)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract metrics from k6 JSON output
              # P95 Latency
              P95=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_req_duration" and .data.tags.expected_response == "true") | .data.value' 2>/dev/null | tail -1)
              
              # Error Rate
              ERROR_RATE=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_req_failed") | .data.value' 2>/dev/null | tail -1)
              
              # Total Requests
              TOTAL_REQS=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_reqs") | .data.value' 2>/dev/null | tail -1)
              
              # Request Rate
              REQ_RATE=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_reqs") | .data.rate' 2>/dev/null | tail -1)
              
              # Display metrics
              if [ ! -z "$P95" ]; then
                echo "  - **P95 Latency:** ${P95}ms" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ ! -z "$ERROR_RATE" ]; then
                ERROR_PCT=$(echo "$ERROR_RATE * 100" | bc -l | xargs printf "%.2f")
                if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
                  echo "  - **Error Rate:** ❌ ${ERROR_PCT}% (threshold: <1%)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "  - **Error Rate:** ✅ ${ERROR_PCT}%" >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              if [ ! -z "$TOTAL_REQS" ]; then
                echo "  - **Total Requests:** ${TOTAL_REQS}" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ ! -z "$REQ_RATE" ]; then
                REQ_RATE_FMT=$(echo "$REQ_RATE" | xargs printf "%.2f")
                echo "  - **Request Rate:** ${REQ_RATE_FMT} req/s" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No results found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full results available in artifacts." >> $GITHUB_STEP_SUMMARY
      
      # Upload results as artifacts
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results-${{ inputs.environment }}
          path: load-test/results/*.json
          retention-days: 10
      
      # Fail job if thresholds not met
      - name: Check Thresholds
        run: |
          # k6 handles thresholds - if they fail, k6 exits with non-zero code
          # This step is just for additional reporting
          echo "Threshold checks completed (handled by k6)"

