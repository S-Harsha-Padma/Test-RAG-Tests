name: Load Testing (Stage)

on:
  workflow_dispatch:

jobs:
  load-test:
    name: Run k6 Load Tests - Stage
    runs-on: ubuntu-latest
    environment: stage
    if: ${{ github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          
      # Install k6 binary
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 -y
          k6 version
      
      
      - name: Get IMS Access Token via Authorization Code
        id: token
        run: |
          echo "Requesting IMS token via OAuth Authorization Code (Stage)..."
          
          IMS_URL="${{ vars.IMS_TOKEN_URL_STAGE }}"
          CLIENT_ID="${{ secrets.CLIENTID_STAGE }}"
          CLIENT_SECRET="${{ secrets.CLIENTSECRET_STAGE }}"
          AUTH_CODE="${{ secrets.AUTH_CODE_STAGE }}"
          
          echo "IMS URL: $IMS_URL"
          echo "Client ID set: $([ -n "$CLIENT_ID" ] && echo 'YES' || echo 'NO')"
          echo "Client Secret set: $([ -n "$CLIENT_SECRET" ] && echo 'YES' || echo 'NO')"
          echo "Auth Code set: $([ -n "$AUTH_CODE" ] && echo 'YES' || echo 'NO')"
          
          RESPONSE=$(curl -s -X POST "$IMS_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=$CLIENT_ID" \
            -d "client_secret=$CLIENT_SECRET" \
            -d "scope=system,openid,AdobeID,read_organizations")
          
          echo "Response received"
          
          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')
          
          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "Failed to get access token"
            echo "Full response: $RESPONSE"
            exit 1
          fi
          
          echo "::add-mask::$TOKEN"
          echo "access_token=$TOKEN" >> $GITHUB_OUTPUT
          echo "Got IMS token successfully!"

      - name: Validate Token
        run: |
          echo "Validating IMS token..."
          
          # Check token is not empty
          if [ -z "${{ steps.token.outputs.access_token }}" ]; then
            echo "Token is empty"
            exit 1
          fi
          
          # Check token format (JWT has 3 parts separated by dots)
          TOKEN_PARTS=$(echo "${{ steps.token.outputs.access_token }}" | tr '.' '\n' | wc -l)
          if [ "$TOKEN_PARTS" -ne 3 ]; then
            echo "Token format invalid (expected 3 parts, got $TOKEN_PARTS)"
            exit 1
          fi
          
          echo "Token format valid!"
      
      
      # Run basic load test
      - name: Run Load Test on Stage
        id: loadtest
        continue-on-error: true  # Don't fail workflow - load balancing will be taken care in phase2
        env:
          APIM_ENDPOINT: ${{ vars.APIM_ENDPOINT_STAGE }}
          IMS_TOKEN: ${{ steps.token.outputs.access_token }}
          CACHE_ENV: stage  # For cache isolation
        run: npm run test:load
      
      # Analyze results
      - name: Analyze Results
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.loadtest.outcome }}" == "success" ]; then
            echo "**Status: PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "All thresholds met!" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status: COMPLETED WITH ERRORS**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Backend scaling/load balancing will be handled in phase2." >> $GITHUB_STEP_SUMMARY
            echo "500 errors are expected during this phase." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The test ran successfully but thresholds were not met due to infrastructure work." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Read from k6 summary file (created by handleSummary function)
          SUMMARY_FILE="load-test-summary.json"
          
          if [ -f "$SUMMARY_FILE" ]; then
            echo "Reading metrics from k6 summary..."
            
            # Extract aggregated metrics from k6 summary JSON
            TOTAL_REQS=$(jq -r '.metrics.http_reqs.values.count // 0' "$SUMMARY_FILE" 2>/dev/null)
            REQ_RATE=$(jq -r '.metrics.http_reqs.values.rate // 0' "$SUMMARY_FILE" 2>/dev/null)
            AVG_DURATION=$(jq -r '.metrics.http_req_duration.values.avg // 0' "$SUMMARY_FILE" 2>/dev/null)
            P95=$(jq -r '.metrics.http_req_duration.values["p(95)"] // 0' "$SUMMARY_FILE" 2>/dev/null)
            FAILED_RATE=$(jq -r '.metrics.http_req_failed.values.rate // 0' "$SUMMARY_FILE" 2>/dev/null)
            TOKENS_USED=$(jq -r '.metrics.tokens_used.values.count // 0' "$SUMMARY_FILE" 2>/dev/null)
            DURATION_MS=$(jq -r '.state.testRunDurationMs // 0' "$SUMMARY_FILE" 2>/dev/null)
            
            # Display duration
            if [ "$DURATION_MS" != "0" ] && [ "$DURATION_MS" != "null" ]; then
              DURATION_SEC=$(echo "scale=1; $DURATION_MS / 1000" | bc 2>/dev/null || echo "0")
              echo "- **Test Duration:** ${DURATION_SEC}s" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Display total requests
            if [ "$TOTAL_REQS" != "0" ] && [ "$TOTAL_REQS" != "null" ]; then
              echo "- **Total Requests:** ${TOTAL_REQS}" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Display request rate
            if [ "$REQ_RATE" != "0" ] && [ "$REQ_RATE" != "null" ]; then
              REQ_RATE_FMT=$(printf "%.2f" "$REQ_RATE" 2>/dev/null || echo "$REQ_RATE")
              echo "- **Request Rate:** ${REQ_RATE_FMT} req/s" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response Times:**" >> $GITHUB_STEP_SUMMARY
            
            if [ "$AVG_DURATION" != "0" ] && [ "$AVG_DURATION" != "null" ]; then
              AVG_FMT=$(printf "%.2f" "$AVG_DURATION" 2>/dev/null || echo "$AVG_DURATION")
              echo "- Average: ${AVG_FMT}ms" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$P95" != "0" ] && [ "$P95" != "null" ]; then
              P95_FMT=$(printf "%.2f" "$P95" 2>/dev/null || echo "$P95")
              echo "- P95: ${P95_FMT}ms" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Calculate success/error rates
            if [ "$FAILED_RATE" != "null" ]; then
              SUCCESS_PCT=$(echo "scale=2; (1 - $FAILED_RATE) * 100" | bc 2>/dev/null || echo "100.00")
              ERROR_PCT=$(echo "scale=2; $FAILED_RATE * 100" | bc 2>/dev/null || echo "0.00")
              echo "- **Success Rate:** ${SUCCESS_PCT}%" >> $GITHUB_STEP_SUMMARY
              
              THRESHOLD_CHECK=$(echo "$FAILED_RATE > 0.01" | bc 2>/dev/null || echo 0)
              if [ "$THRESHOLD_CHECK" = "1" ]; then
                echo "- **Error Rate:** ${ERROR_PCT}% (threshold: <1%)" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **Error Rate:** ${ERROR_PCT}%" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # Display token usage
            if [ "$TOKENS_USED" != "0" ] && [ "$TOKENS_USED" != "null" ] && [ "$TOTAL_REQS" != "0" ]; then
              AVG_TOKENS=$(echo "scale=0; $TOKENS_USED / $TOTAL_REQS" | bc 2>/dev/null || echo "0")
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Custom Metrics:**" >> $GITHUB_STEP_SUMMARY
              echo "- Total Tokens Used: ${TOKENS_USED}" >> $GITHUB_STEP_SUMMARY
              echo "- Avg Tokens/Request: ${AVG_TOKENS}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "Summary file not found (load-test-summary.json)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The k6 terminal output above shows the correct metrics." >> $GITHUB_STEP_SUMMARY
          fi