name: Load Testing

on:
  # Or run manually
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'test'
        type: choice
        options:
          - dev
          - prod

jobs:
  load-test:
    name: Run k6 Load Tests - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      # Install k6 binary
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 -y
          k6 version
      
      # Get IMS token for authentication
      - name: Get IMS Token
        id: ims-token
        run: |
          # Get credentials dynamically based on environment
          if [ "${{ inputs.environment }}" = "prod" ]; then
            CLIENT_ID="${{ secrets.CLIENT_ID_PROD }}"
            CLIENT_SECRET="${{ secrets.CLIENT_SECRET_PROD }}"
            IMS_URL="${{ vars.IMS_TOKEN_URL_PROD }}"
            echo "Using PROD credentials"
          else
            CLIENT_ID="${{ secrets.CLIENT_ID_STAGE }}"
            CLIENT_SECRET="${{ secrets.CLIENT_SECRET_STAGE }}"
            IMS_URL="${{ vars.IMS_TOKEN_URL_STAGE }}"
            echo "Using STAGE credentials"
          fi
          
          # Validate credentials are set
          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ] || [ -z "$IMS_URL" ]; then
            echo "âŒ Error: Missing credentials for ${{ inputs.environment }}"
            echo "CLIENT_ID set: $([ -z "$CLIENT_ID" ] && echo "NO" || echo "YES")"
            echo "CLIENT_SECRET set: $([ -z "$CLIENT_SECRET" ] && echo "NO" || echo "YES")"
            echo "IMS_URL: $IMS_URL"
            exit 1
          fi
          
          echo "Fetching token from: $IMS_URL"
          
          # Get token using selected credentials
          TOKEN=$(curl -s -X POST "$IMS_URL" \
            -d "grant_type=client_credentials" \
            -d "client_id=$CLIENT_ID" \
            -d "client_secret=$CLIENT_SECRET" \
            -d "scope=openid,AdobeID" | jq -r '.access_token')
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âŒ Failed to get token from IMS"
            exit 1
          fi
          
          echo "âœ… Token obtained successfully"
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
      
      # Run basic load test
      - name: Run Load Test on ${{ inputs.environment }}
        env:
          APIM_ENDPOINT: ${{ inputs.environment == 'prod' && vars.APIM_ENDPOINT_PROD || vars.APIM_ENDPOINT_STAGE }}
          IMS_TOKEN: ${{ steps.ims-token.outputs.token }}
          CACHE_ENV: ${{ inputs.environment }}  # For cache isolation
        run: npm run test:load
      
      # Analyze results
      - name: Analyze Results
        if: always()
        run: |
          echo "## ðŸ“Š Load Test Results - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for any result files
          if ls load-test/results/*.json 1> /dev/null 2>&1; then
            echo "### Load Test Summary" >> $GITHUB_STEP_SUMMARY
            for file in load-test/results/*.json; do
              echo "- Test: $(basename $file .json)" >> $GITHUB_STEP_SUMMARY
              # Extract P95 if available
              P95=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_req_duration") | .data.value' 2>/dev/null | head -1)
              if [ ! -z "$P95" ]; then
                echo "  - P95 Latency: ${P95}ms" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "- No results found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full results available in artifacts." >> $GITHUB_STEP_SUMMARY
      
      # Upload results as artifacts
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results-${{ inputs.environment }}
          path: load-test/results/*.json
          retention-days: 10
      
      # Fail job if thresholds not met
      - name: Check Thresholds
        run: |
          # k6 handles thresholds - if they fail, k6 exits with non-zero code
          # This step is just for additional reporting
          echo "Threshold checks completed (handled by k6)"

