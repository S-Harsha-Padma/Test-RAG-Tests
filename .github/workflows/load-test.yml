name: Load Testing

on:
  # Or run manually
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

jobs:
  load-test:
    name: Run k6 Load Tests - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}  # Use the selected environment (dev/prod)
    if: ${{ github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      # Install k6 binary
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 -y
          k6 version
      
      # Get IMS token for authentication
      - name: Get IMS Token
        id: ims-token
        run: |
          # OPTION 1: Use personal token if provided (premium tier: 1000 calls/min)
          if [ -n "${{ secrets.IMS_TOKEN_PERSONAL }}" ]; then
            echo "ðŸŽ¯ Using personal Adobe token (premium tier: 1000 calls/min)"
            echo "âœ… No rate limit issues expected"
            TOKEN="${{ secrets.IMS_TOKEN_PERSONAL }}"
            echo "::add-mask::$TOKEN"
            echo "token=$TOKEN" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âš ï¸  No IMS_TOKEN_PERSONAL found - using service credentials (free tier: 10 calls/min)"
          echo "ðŸ’¡ To avoid rate limits, add IMS_TOKEN_PERSONAL secret from: aio auth login --bare"
          echo ""
          echo "ðŸ” Debug Info:"
          echo "  - Selected environment: ${{ inputs.environment }}"
          echo "  - Environment context: ${{ github.environment }}"
          echo ""
          
          # Get credentials dynamically based on environment
          if [ "${{ inputs.environment }}" = "prod" ]; then
            CLIENT_ID="${{ secrets.CLIENT_ID_PROD }}"
            CLIENT_SECRET="${{ secrets.CLIENT_SECRET_PROD }}"
            IMS_URL="${{ vars.IMS_TOKEN_URL_PROD }}"
            echo "Using PROD credentials (looking for _PROD suffix)"
          else
            CLIENT_ID="${{ secrets.CLIENT_ID_STAGE }}"
            CLIENT_SECRET="${{ secrets.CLIENT_SECRET_STAGE }}"
            IMS_URL="${{ vars.IMS_TOKEN_URL_STAGE }}"
            echo "Using STAGE credentials (looking for _STAGE suffix)"
          fi
          
          echo ""
          echo "ðŸ” Credential Check:"
          # Validate credentials are set
          if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ] || [ -z "$IMS_URL" ]; then
            echo "âŒ Error: Missing credentials for ${{ inputs.environment }}"
            echo "  - CLIENT_ID set: $([ -z "$CLIENT_ID" ] && echo "NO âŒ" || echo "YES âœ…")"
            echo "  - CLIENT_SECRET set: $([ -z "$CLIENT_SECRET" ] && echo "NO âŒ" || echo "YES âœ…")"
            echo "  - IMS_URL set: $([ -z "$IMS_URL" ] && echo "NO âŒ" || echo "YES âœ…")"
            echo "  - IMS_URL value: '$IMS_URL'"
            echo ""
            echo "ðŸ’¡ Troubleshooting:"
            echo "  1. Verify environment '${{ inputs.environment }}' exists in GitHub Settings â†’ Environments"
            echo "  2. Check that secrets CLIENT_ID_STAGE and CLIENT_SECRET_STAGE exist in that environment"
            echo "  3. Check that variables IMS_TOKEN_URL_STAGE and APIM_ENDPOINT_STAGE exist in that environment"
            exit 1
          fi
          
          echo "Fetching token from: $IMS_URL"
          
          # Get token using selected credentials
          # TOKEN=$(curl -s -X POST "$IMS_URL" \
          #   -d "grant_type=client_credentials" \
          #   -d "client_id=$CLIENT_ID" \
          #   -d "client_secret=$CLIENT_SECRET" \
          #   -d "scope=openid,AdobeID" | jq -r '.access_token')
          
          # if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          #   echo "âŒ Failed to get token from IMS"
          #   exit 1
          # fi
          
          # echo "âœ… Token obtained successfully"
          # echo "::add-mask::$TOKEN"
          # echo "token=$TOKEN" >> $GITHUB_OUTPUT
          
          # OAuth S2S disabled - you MUST set IMS_TOKEN_PERSONAL in GitHub secrets!
          echo "âŒ Error: No token available!"
          echo "OAuth S2S is disabled (commented out above)"
          echo ""
          echo "To run load tests, you MUST add IMS_TOKEN_PERSONAL secret:"
          echo "  1. Run locally: aio auth login --bare"
          echo "  2. Copy the token output"
          echo "  3. Go to: Settings â†’ Secrets and variables â†’ Actions"
          echo "  4. Add secret: IMS_TOKEN_PERSONAL = (paste token)"
          echo ""
          echo "This gives you premium tier (1000 calls/min) for testing!"
          exit 1
      
      # Run basic load test
      - name: Run Load Test on ${{ inputs.environment }}
        env:
          APIM_ENDPOINT: ${{ inputs.environment == 'prod' && vars.APIM_ENDPOINT_PROD || vars.APIM_ENDPOINT_STAGE }}
          IMS_TOKEN: ${{ steps.ims-token.outputs.token }}
          CACHE_ENV: ${{ inputs.environment }}  # For cache isolation
        run: npm run test:load
      
      # Analyze results
      - name: Analyze Results
        if: always()
        run: |
          echo "## ðŸ“Š Load Test Results - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for any result files
          if ls load-test/results/*.json 1> /dev/null 2>&1; then
            echo "### Load Test Summary" >> $GITHUB_STEP_SUMMARY
            for file in load-test/results/*.json; do
              echo "- Test: $(basename $file .json)" >> $GITHUB_STEP_SUMMARY
              # Extract P95 if available
              P95=$(cat "$file" | jq -r 'select(.type == "Point" and .metric == "http_req_duration") | .data.value' 2>/dev/null | head -1)
              if [ ! -z "$P95" ]; then
                echo "  - P95 Latency: ${P95}ms" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "- No results found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full results available in artifacts." >> $GITHUB_STEP_SUMMARY
      
      # Upload results as artifacts
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results-${{ inputs.environment }}
          path: load-test/results/*.json
          retention-days: 10
      
      # Fail job if thresholds not met
      - name: Check Thresholds
        run: |
          # k6 handles thresholds - if they fail, k6 exits with non-zero code
          # This step is just for additional reporting
          echo "Threshold checks completed (handled by k6)"

